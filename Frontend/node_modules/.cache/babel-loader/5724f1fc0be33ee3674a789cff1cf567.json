{"ast":null,"code":"import _regeneratorRuntime from\"/home/siyamak/Documents/MetaMask-Login-Python/frontend/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";import _asyncToGenerator from\"/home/siyamak/Documents/MetaMask-Login-Python/frontend/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _slicedToArray from\"/home/siyamak/Documents/MetaMask-Login-Python/frontend/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import{createContext,useState}from\"react\";import Web3Modal from\"web3modal\";import{ethers}from\"ethers\";import axios from\"axios\";import{jsx as _jsx}from\"react/jsx-runtime\";var api_host=\"http://localhost:8000\";var AccountInfoContext=/*#__PURE__*/createContext({access_token:null,user_obj:null,connectWallet:function connectWallet(){},signer:null,loginCheck:function loginCheck(){},logout:function logout(){}});export function AccountInfoContextProvider(props){var _useState=useState(null),_useState2=_slicedToArray(_useState,2),accessToken=_useState2[0],setAccessToken=_useState2[1];var _useState3=useState(null),_useState4=_slicedToArray(_useState3,2),user_obj=_useState4[0],setUser_obj=_useState4[1];var _useState5=useState(null),_useState6=_slicedToArray(_useState5,2),web3signer=_useState6[0],setWeb3signer=_useState6[1];function login(_x){return _login.apply(this,arguments);}function _login(){_login=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee(signer){var address,meta,signature,data;return _regeneratorRuntime().wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return signer.getAddress();case 2:address=_context.sent;_context.next=5;return axios.get(api_host+\"/user_svc/get_captcha/?web3_address=\"+address);case 5:meta=_context.sent;//http://127.0.0.1:8000/user_svc/get_captcha/?web3_address=xyz\n// ask for sign\nsignature=null;_context.prev=7;_context.next=10;return signer.signMessage(meta.data.data.captcha);case 10:signature=_context.sent;_context.next=16;break;case 13:_context.prev=13;_context.t0=_context[\"catch\"](7);console.log(\"signature declined!\",_context.t0);case 16:// login\nif(signature){data={web3_address:address,signature:signature};// console.log(data);\n// get token , is first_login\naxios.post(api_host+\"/user_svc/web3_login/\",data).then(function(response){if(response.status==200){console.log(response.data);// set access token\nvar access_token=null;if(response.data.token){access_token=\"token \"+response.data.token;}setAccessToken(access_token);setUser_obj(response.data.data);setWeb3signer(signer);window.sessionStorage.setItem(\"user_obj\",JSON.stringify(response.data.data));window.sessionStorage.setItem(\"access_token\",access_token);// console.log(\"login successful\");\n}else{alert(\"login failed try again!\");}}).catch(function(err){// console.log(err);\nalert(\"login failed\");});;}else{alert(\"signature declined!\");}case 17:case\"end\":return _context.stop();}}},_callee,null,[[7,13]]);}));return _login.apply(this,arguments);}function logout(){setUser_obj(null);setAccessToken(null);setWeb3signer(null);window.sessionStorage.removeItem(\"user_obj\");window.sessionStorage.removeItem(\"access_token\");// remove access token\n}function onAccountChange(_x2){return _onAccountChange.apply(this,arguments);}function _onAccountChange(){_onAccountChange=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee2(accounts){return _regeneratorRuntime().wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:logout();// const signer = await setupWallet();\n// await login(signer);\ncase 1:case\"end\":return _context2.stop();}}},_callee2);}));return _onAccountChange.apply(this,arguments);}function onNetworkChange(_x3){return _onNetworkChange.apply(this,arguments);}function _onNetworkChange(){_onNetworkChange=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee3(chainId){return _regeneratorRuntime().wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:console.log(\"chainChanged\",chainId);if(chainId!='0x539'){alert(\"network not supported!\");// try {\n//   // check if the chain to connect to is installed\n//   await window.ethereum.request({\n//     method: 'wallet_switchEthereumChain',\n//     params: [{ chainId: '0x539' }], // chainId must be in hexadecimal numbers\n//   });\n// } catch (error) {\n//   // This error code indicates that the chain has not been added to MetaMask\n//   // if it is not, then install it into the user MetaMask\n//   if (error.code === 4902) {\n//     try {\n//       await window.ethereum.request({\n//         method: 'wallet_addEthereumChain',\n//         params: [\n//           {\n//             chainId: '0x539',\n//             rpcUrl: 'http://149.28.175.112:8545',\n//           },\n//         ],\n//       });\n//     } catch (addError) {\n//       console.error(addError);\n//     }\n//   }\n//   console.error(error);\n// }\n}case 2:case\"end\":return _context3.stop();}}},_callee3);}));return _onNetworkChange.apply(this,arguments);}function setupWallet(){return _setupWallet.apply(this,arguments);}function _setupWallet(){_setupWallet=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee4(){var web3Modal,connection,provider,signer;return _regeneratorRuntime().wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:web3Modal=new Web3Modal({network:\"mainnet\",cacheProvider:true});_context4.next=3;return web3Modal.connect();case 3:connection=_context4.sent;provider=new ethers.providers.Web3Provider(connection);connection.on(\"accountsChanged\",function(accounts){onAccountChange(accounts);});connection.on(\"chainChanged\",function(chainId){onNetworkChange(chainId);});// // Subscribe to provider connection\n// connection.on(\"connect\", (info) => {\n//   console.log(\"connected\",info);\n// });\n// // Subscribe to provider disconnection\n// connection.on(\"disconnect\",(error) => {\n//   console.log(\"disconnect\",error);\n// });\nsigner=provider.getSigner();return _context4.abrupt(\"return\",signer);case 9:case\"end\":return _context4.stop();}}},_callee4);}));return _setupWallet.apply(this,arguments);}function ConnectWalletHandler(_x4){return _ConnectWalletHandler.apply(this,arguments);}function _ConnectWalletHandler(){_ConnectWalletHandler=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee5(props){var signer;return _regeneratorRuntime().wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:if(!(typeof window.ethereum!==\"undefined\")){_context5.next=7;break;}_context5.next=3;return setupWallet();case 3:signer=_context5.sent;login(signer);_context5.next=8;break;case 7:alert(\"metamask not installed!\");case 8:case\"end\":return _context5.stop();}}},_callee5);}));return _ConnectWalletHandler.apply(this,arguments);}function LoginCheckSession(){return _LoginCheckSession.apply(this,arguments);}function _LoginCheckSession(){_LoginCheckSession=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee6(){var user_obj,access_token,signer,address;return _regeneratorRuntime().wrap(function _callee6$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:user_obj=window.sessionStorage.getItem(\"user_obj\")?JSON.parse(window.sessionStorage.getItem(\"user_obj\")):null;access_token=window.sessionStorage.getItem(\"access_token\");_context6.next=4;return setupWallet();case 4:signer=_context6.sent;_context6.next=7;return signer.getAddress();case 7:address=_context6.sent;// console.log(user_obj,address);\nif(user_obj&&access_token){if(user_obj.web3_address==address){setAccessToken(access_token);setUser_obj(user_obj);setWeb3signer(signer);}else{logout();}}else{logout();}case 9:case\"end\":return _context6.stop();}}},_callee6);}));return _LoginCheckSession.apply(this,arguments);}var context={access_token:accessToken,user_obj:user_obj,connectWallet:ConnectWalletHandler,signer:web3signer,loginCheck:LoginCheckSession,logout:logout};return/*#__PURE__*/_jsx(AccountInfoContext.Provider,{value:context,children:props.children});}export default AccountInfoContext;","map":{"version":3,"names":["createContext","useState","Web3Modal","ethers","axios","api_host","AccountInfoContext","access_token","user_obj","connectWallet","signer","loginCheck","logout","AccountInfoContextProvider","props","accessToken","setAccessToken","setUser_obj","web3signer","setWeb3signer","login","getAddress","address","get","meta","signature","signMessage","data","captcha","console","log","web3_address","post","then","response","status","token","window","sessionStorage","setItem","JSON","stringify","alert","catch","err","removeItem","onAccountChange","accounts","onNetworkChange","chainId","setupWallet","web3Modal","network","cacheProvider","connect","connection","provider","providers","Web3Provider","on","getSigner","ConnectWalletHandler","ethereum","LoginCheckSession","getItem","parse","context","children"],"sources":["/home/siyamak/Documents/MetaMask-Login-Python/frontend/src/components/ctx/account-context.js"],"sourcesContent":["import { createContext, useState } from \"react\";\nimport Web3Modal from \"web3modal\";\nimport { ethers } from \"ethers\";\nimport axios from \"axios\";\n\nconst api_host = \"http://localhost:8000\";\n\nconst AccountInfoContext = createContext({\n    access_token: null,\n    user_obj: null,\n    connectWallet: () => {},\n    signer: null,\n    loginCheck: () => {},\n    logout: () => {},\n  });\n  \n  export function AccountInfoContextProvider(props) {\n    const [accessToken, setAccessToken] = useState(null);\n    const [user_obj, setUser_obj] = useState(null);\n    const [web3signer, setWeb3signer] = useState(null);\n  \n    async function login(signer) {\n      const address = await signer.getAddress();\n      // get nounce for this user\n      const meta = await axios.get(api_host + \"/user_svc/get_captcha/?web3_address=\" + address); //http://127.0.0.1:8000/user_svc/get_captcha/?web3_address=xyz\n  \n      // ask for sign\n      let signature = null;\n      try{\n        signature = await signer.signMessage(meta.data.data.captcha);\n      }catch(e){\n        console.log(\"signature declined!\",e)\n      }\n      \n      // login\n      if(signature){\n        const data = {\n          web3_address: address,\n          signature: signature,\n        };\n        // console.log(data);\n        // get token , is first_login\n        axios.post(api_host + \"/user_svc/web3_login/\", data).then((response) => {\n          if(response.status==200){\n            console.log(response.data);\n            // set access token\n            let access_token = null\n            if(response.data.token){\n              access_token = \"token \"+response.data.token\n            }\n            \n            setAccessToken(access_token);\n            setUser_obj(response.data.data);\n            setWeb3signer(signer);\n            window.sessionStorage.setItem(\"user_obj\", JSON.stringify(response.data.data));\n            window.sessionStorage.setItem(\"access_token\", access_token);\n            // console.log(\"login successful\");\n          }else{\n            alert(\"login failed try again!\")\n          }\n        }).catch((err)=>{\n            // console.log(err);\n            alert(\"login failed\");\n        });;\n        \n      }else{\n        alert(\"signature declined!\")\n      }\n      \n    }\n  \n    function logout() {\n      setUser_obj(null);\n      setAccessToken(null);\n      setWeb3signer(null);\n      window.sessionStorage.removeItem(\"user_obj\");\n      window.sessionStorage.removeItem(\"access_token\");\n      // remove access token\n    }\n    async function onAccountChange(accounts) {\n      logout();\n      // const signer = await setupWallet();\n      // await login(signer);\n    }\n  \n    async function onNetworkChange(chainId) {\n      console.log(\"chainChanged\",chainId);\n      if(chainId !='0x539'){\n        alert(\"network not supported!\")\n        // try {\n        //   // check if the chain to connect to is installed\n        //   await window.ethereum.request({\n        //     method: 'wallet_switchEthereumChain',\n        //     params: [{ chainId: '0x539' }], // chainId must be in hexadecimal numbers\n        //   });\n        // } catch (error) {\n        //   // This error code indicates that the chain has not been added to MetaMask\n        //   // if it is not, then install it into the user MetaMask\n        //   if (error.code === 4902) {\n        //     try {\n        //       await window.ethereum.request({\n        //         method: 'wallet_addEthereumChain',\n        //         params: [\n        //           {\n        //             chainId: '0x539',\n        //             rpcUrl: 'http://149.28.175.112:8545',\n        //           },\n        //         ],\n        //       });\n        //     } catch (addError) {\n        //       console.error(addError);\n        //     }\n        //   }\n        //   console.error(error);\n        // }\n      }\n    }\n  \n    async function setupWallet() {\n      const web3Modal = new Web3Modal({\n        network: \"mainnet\",\n        cacheProvider: true,\n      });\n      const connection = await web3Modal.connect();\n      const provider = new ethers.providers.Web3Provider(connection);\n  \n      connection.on(\"accountsChanged\", (accounts) => {\n        onAccountChange(accounts);\n      });\n  \n      connection.on(\"chainChanged\", (chainId) => {\n        onNetworkChange(chainId)\n      });\n      \n      // // Subscribe to provider connection\n      // connection.on(\"connect\", (info) => {\n      //   console.log(\"connected\",info);\n      // });\n      \n      // // Subscribe to provider disconnection\n      // connection.on(\"disconnect\",(error) => {\n      //   console.log(\"disconnect\",error);\n      // });\n  \n      const signer = provider.getSigner();\n      return signer;\n    }\n  \n    async function ConnectWalletHandler(props) {\n      if (typeof window.ethereum !== \"undefined\") {\n        // console.log(\"connect wallet cicked\");\n        const signer = await setupWallet();\n        login(signer);\n      }\n      else{\n        alert(\"metamask not installed!\");\n      }\n    }\n  \n    async function LoginCheckSession() {\n      const user_obj = window.sessionStorage.getItem(\"user_obj\")?JSON.parse(window.sessionStorage.getItem(\"user_obj\")):null;\n      const access_token = window.sessionStorage.getItem(\"access_token\");\n  \n      const signer = await setupWallet();\n      const address = await signer.getAddress();\n  \n      // console.log(user_obj,address);\n      if (user_obj && access_token) {\n          if (user_obj.web3_address == address){\n              setAccessToken(access_token);\n              setUser_obj(user_obj);\n              setWeb3signer(signer);\n          }else{\n              logout()\n          }\n        \n      } else {\n        logout();\n      }\n    }\n  \n    const context = {\n      access_token: accessToken,\n      user_obj: user_obj,\n      connectWallet: ConnectWalletHandler,\n      signer: web3signer,\n      loginCheck: LoginCheckSession,\n      logout: logout,\n    };\n    return (\n      <AccountInfoContext.Provider value={context}>\n        {props.children}\n      </AccountInfoContext.Provider>\n    );\n  }\n  \n  export default AccountInfoContext;"],"mappings":"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"},"metadata":{},"sourceType":"module"}